---
#file roles/apt-upgrade/tasks/main.yml
- name: Ensure aptitude is installed
  apt: name=aptitude state=latest update_cache=yes cache_valid_time=3600

- name: Run apt-get autoclean
  command: apt-get -y autoclean

- name: Run apt-get autoremove
  command: apt-get -y autoremove

- name: Run apt-upgrade safely
  apt: update_cache=yes upgrade=safe cache_valid_time=3600

- name: Reboot system if required
  command: shutdown -r 1 "Rebooting to complete system upgrade" removes=/var/run/reboot-required
  when: "'henry' not in inventory_hostname"
  async: 0
  poll: 0
  ignore_errors: true
  register: rebooting

- name: Wait for server to reboot...
  local_action: wait_for
    host={{ inventory_hostname }}
    port=22
    state=started
    delay=65
    timeout=120
  become: false
  when: rebooting
